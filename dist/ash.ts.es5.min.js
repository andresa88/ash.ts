!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).ash={})}(this,function(t){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,n)};function __extends(t,n){function __(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}function __values(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function __read(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,o,r=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=r.next()).done;)s.push(i.value)}catch(t){o={error:t}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(o)throw o.error}}return s}var n=function(){return function ListenerNode(){this.previous=null,this.next=null,this.listener=null,this.once=!1}}(),i=function(){function ListenerNodePool(){this.tail=null,this.cacheTail=null}return ListenerNodePool.prototype.get=function(){if(this.tail){var t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}return new n},ListenerNodePool.prototype.dispose=function(t){t.listener=null,t.once=!1,t.next=null,t.previous=this.tail,this.tail=t},ListenerNodePool.prototype.cache=function(t){t.listener=null,t.previous=this.cacheTail,this.cacheTail=t},ListenerNodePool.prototype.releaseCache=function(){for(;this.cacheTail;){var t=this.cacheTail;this.cacheTail=t.previous,t.next=null,t.previous=this.tail,this.tail=t}},ListenerNodePool}(),o=function(){function SignalBase(){this.head=null,this.tail=null,this.toAddHead=null,this.toAddTail=null,this.dispatching=!1,this.pNumListeners=0,this.nodes=new Map,this.listenerNodePool=new i}return SignalBase.prototype.startDispatch=function(){this.dispatching=!0},SignalBase.prototype.endDispatch=function(){this.dispatching=!1,this.toAddHead&&(this.head?(this.tail.next=this.toAddHead,this.toAddHead.previous=this.tail,this.tail=this.toAddTail):(this.head=this.toAddHead,this.tail=this.toAddTail),this.toAddHead=null,this.toAddTail=null),this.listenerNodePool.releaseCache()},Object.defineProperty(SignalBase.prototype,"numListeners",{get:function(){return this.pNumListeners},enumerable:!0,configurable:!0}),SignalBase.prototype.add=function(t){if(!this.nodes.has(t)){var e=this.listenerNodePool.get();e.listener=t,this.nodes.set(t,e),this.addNode(e)}},SignalBase.prototype.addOnce=function(t){if(!this.nodes.has(t)){var e=this.listenerNodePool.get();e.listener=t,e.once=!0,this.nodes.set(t,e),this.addNode(e)}},SignalBase.prototype.addNode=function(t){this.dispatching?this.toAddHead?(this.toAddTail.next=t,t.previous=this.toAddTail,this.toAddTail=t):this.toAddHead=this.toAddTail=t:this.head?(this.tail.next=t,t.previous=this.tail,this.tail=t):this.head=this.tail=t,this.pNumListeners+=1},SignalBase.prototype.remove=function(t){var e=this.nodes.get(t)||null;e&&(this.head===e&&(this.head=this.head.next),this.tail===e&&(this.tail=this.tail.previous),this.toAddHead===e&&(this.toAddHead=this.toAddHead.next),this.toAddTail===e&&(this.toAddTail=this.toAddTail.previous),e.previous&&(e.previous.next=e.next),e.next&&(e.next.previous=e.previous),this.nodes.delete(t),this.dispatching?this.listenerNodePool.cache(e):this.listenerNodePool.dispose(e),this.pNumListeners-=1)},SignalBase.prototype.removeAll=function(){for(;this.head;){var t=this.head;this.head=this.head.next,this.nodes.delete(t.listener),this.listenerNodePool.dispose(t)}this.tail=null,this.toAddHead=null,this.toAddTail=null,this.pNumListeners=0},SignalBase}(),r=function(t){function Signal0(){return null!==t&&t.apply(this,arguments)||this}return __extends(Signal0,t),Signal0.prototype.dispatch=function(){var t;for(this.startDispatch(),t=this.head;t;t=t.next)t.listener.call(t),t.once&&this.remove(t.listener);this.endDispatch()},Signal0}(o),s=function(t){function Signal1(){return null!==t&&t.apply(this,arguments)||this}return __extends(Signal1,t),Signal1.prototype.dispatch=function(t){var e;for(this.startDispatch(),e=this.head;e;e=e.next)e.listener.call(e,t),e.once&&this.remove(e.listener);this.endDispatch()},Signal1}(o),a=function(t){function Signal2(){return null!==t&&t.apply(this,arguments)||this}return __extends(Signal2,t),Signal2.prototype.dispatch=function(t,e){var n;for(this.startDispatch(),n=this.head;n;n=n.next)n.listener.call(n,t,e),n.once&&this.remove(n.listener);this.endDispatch()},Signal2}(o),h=function(t){function Signal3(){return null!==t&&t.apply(this,arguments)||this}return __extends(Signal3,t),Signal3.prototype.dispatch=function(t,e,n){var i;for(this.startDispatch(),i=this.head;i;i=i.next)i.listener.call(i,t,e,n),i.once&&this.remove(i.listener);this.endDispatch()},Signal3}(o),l=function(){function NodeList(){this.head=null,this.tail=null,this.nodeAdded=new s,this.nodeRemoved=new s}return NodeList.prototype.add=function(t){this.head?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=this.tail=t,t.next=t.previous=null),this.nodeAdded.dispatch(t)},NodeList.prototype.remove=function(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous),this.nodeRemoved.dispatch(t)},NodeList.prototype.removeAll=function(){for(;this.head;){var t=this.head;this.head=t.next,t.previous=null,t.next=null,this.nodeRemoved.dispatch(t)}this.tail=null},Object.defineProperty(NodeList.prototype,"empty",{get:function(){return null==this.head},enumerable:!0,configurable:!0}),NodeList.prototype.swap=function(t,e){if(t.previous===e)t.previous=e.previous,e.previous=t,e.next=t.next,t.next=e;else if(e.previous===t)e.previous=t.previous,t.previous=e,t.next=e.next,e.next=t;else{var n=t.previous;t.previous=e.previous,e.previous=n,n=t.next,t.next=e.next,e.next=n}this.head===t?this.head=e:this.head===e&&(this.head=t),this.tail===t?this.tail=e:this.tail===e&&(this.tail=t),t.previous&&(t.previous.next=t),e.previous&&(e.previous.next=e),t.next&&(t.next.previous=t),e.next&&(e.next.previous=e)},NodeList.prototype.insertionSort=function(t){if(this.head&&this.tail&&this.head!==this.tail)for(var e=this.head.next,n=e;n;n=e){var i=void 0;for(e=n.next,i=n.previous;i;i=i.previous)if(t(n,i)>=0){n!==i.next&&(this.tail===n&&(this.tail=n.previous),n.previous.next=n.next,n.next&&(n.next.previous=n.previous),n.next=i.next,n.previous=i,n.next.previous=n,i.next=n);break}i||(this.tail===n&&(this.tail=n.previous),n.previous.next=n.next,n.next&&(n.next.previous=n.previous),n.next=this.head,this.head.previous=n,n.previous=null,this.head=n)}},NodeList.prototype.mergeSort=function(t){if(this.head!==this.tail){for(var e,n=[],i=this.head;i;){for(e=i;e.next&&t(e,e.next)<=0;)e=e.next;var o=e.next;i.previous=e.next=null,n[n.length]=i,i=o}for(;n.length>1;)n.push(this.merge(n.shift(),n.shift(),t));for(this.tail=this.head=n[0];this.tail.next;)this.tail=this.tail.next}},NodeList.prototype.merge=function(t,e,n){var i,o;for(n(t,e)<=0?(o=i=t,t=t.next):(o=i=e,e=e.next);t&&e;)n(t,e)<=0?(i.next=t,t.previous=i,i=t,t=t.next):(i.next=e,e.previous=i,i=e,e=e.next);return t?(i.next=t,t.previous=i):(i.next=e,e.previous=i),o},NodeList}(),p=function(){function NodePool(t,e){this.tail=null,this.cacheTail=null,this.nodeClass=t,this.components=e}return NodePool.prototype.get=function(){if(this.tail){var t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}return new this.nodeClass},NodePool.prototype.dispose=function(t){var e,n;try{for(var i=__values(this.components.values()),o=i.next();!o.done;o=i.next()){t[o.value]=null}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}t.entity=null,t.next=null,t.previous=this.tail,this.tail=t},NodePool.prototype.cache=function(t){t.previous=this.cacheTail,this.cacheTail=t},NodePool.prototype.releaseCache=function(){for(;this.cacheTail;){var t=this.cacheTail;this.cacheTail=t.previous,this.dispose(t)}},NodePool}(),d="__ash_types__",u=function(){function ComponentMatchingFamily(t,e){var n,i,o=this;this.releaseNodePoolCache=function(){o.engine.updateComplete.remove(o.releaseNodePoolCache),o.nodePool.releaseCache()},this.nodeClass=t,this.engine=e,this.nodes=new l,this.entities=new Map,this.components=new Map,this.nodePool=new p(this.nodeClass,this.components);var r=this.nodePool.get();this.nodePool.dispose(r);var s=r.constructor[d];try{for(var a=__values(s),h=a.next();!h.done;h=a.next()){var u=__read(h.value,2),c=u[0],y=u[1];this.components.set(y,c)}}catch(t){n={error:t}}finally{try{h&&!h.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}}return Object.defineProperty(ComponentMatchingFamily.prototype,"nodeList",{get:function(){return this.nodes},enumerable:!0,configurable:!0}),ComponentMatchingFamily.prototype.newEntity=function(t){this.addIfMatch(t)},ComponentMatchingFamily.prototype.componentAddedToEntity=function(t,e){this.addIfMatch(t)},ComponentMatchingFamily.prototype.componentRemovedFromEntity=function(t,e){this.components.has(e)&&this.removeIfMatch(t)},ComponentMatchingFamily.prototype.removeEntity=function(t){this.removeIfMatch(t)},ComponentMatchingFamily.prototype.addIfMatch=function(t){var e,n,i,o;if(!this.entities.has(t)){try{for(var r=__values(this.components.keys()),s=r.next();!s.done;s=r.next()){var a=s.value;if(!t.has(a))return}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}var h=this.nodePool.get();h.entity=t;try{for(var l=__values(this.components.keys()),p=l.next();!p.done;p=l.next()){a=p.value;h[this.components.get(a)]=t.get(a)}}catch(t){i={error:t}}finally{try{p&&!p.done&&(o=l.return)&&o.call(l)}finally{if(i)throw i.error}}this.entities.set(t,h),this.nodes.add(h)}},ComponentMatchingFamily.prototype.removeIfMatch=function(t){if(this.entities.has(t)){var e=this.entities.get(t);this.entities.delete(t),this.nodes.remove(e),this.engine.updating?(this.nodePool.cache(e),this.engine.updateComplete.add(this.releaseNodePoolCache)):this.nodePool.dispose(e)}},ComponentMatchingFamily.prototype.cleanUp=function(){for(var t=this.nodes.head;t;t=t.next)this.entities.delete(t.entity);this.nodes.removeAll()},ComponentMatchingFamily}();var c=function(){function EntityList(){this.head=null,this.tail=null}return EntityList.prototype.add=function(t){this.head?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=this.tail=t,t.next=t.previous=null)},EntityList.prototype.remove=function(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)},EntityList.prototype.removeAll=function(){for(;this.head;){var t=this.head;this.head=this.head.next,t.previous=null,t.next=null}this.tail=null},EntityList}(),y=function(){function SystemList(){this.head=null,this.tail=null}return SystemList.prototype.add=function(t){if(this.head){var e=void 0;for(e=this.tail;e&&!(e.priority<=t.priority);e=e.previous);e===this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):e?(t.next=e.next,t.previous=e,e.next.previous=t,e.next=t):(t.next=this.head,t.previous=null,this.head.previous=t,this.head=t)}else this.head=this.tail=t,t.next=t.previous=null},SystemList.prototype.remove=function(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)},SystemList.prototype.removeAll=function(){for(;this.head;){var t=this.head;this.head=this.head.next,t.previous=null,t.next=null}this.tail=null},SystemList.prototype.get=function(t){for(var e=this.head;e;e=e.next)if(e instanceof t)return e;return null},SystemList}(),f=function(){function Engine(){var t=this;this.updating=!1,this.familyClass=u,this.entityNameChanged=function(e,n){t.entityNames.get(n)===e&&(t.entityNames.delete(n),t.entityNames.set(e.name,e))},this.componentAdded=function(e,n){var i,o;try{for(var r=__values(t.families.values()),s=r.next();!s.done;s=r.next()){s.value.componentAddedToEntity(e,n)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}},this.componentRemoved=function(e,n){var i,o;try{for(var r=__values(t.families.values()),s=r.next();!s.done;s=r.next()){s.value.componentRemovedFromEntity(e,n)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}},this.entityList=new c,this.entityNames=new Map,this.systemList=new y,this.families=new Map,this.updateComplete=new r}return Engine.prototype.addEntity=function(t){var e,n;if(this.entityNames.has(t.name))throw new Error("The entity name "+t.name+" is already in use by another entity.");this.entityList.add(t),this.entityNames.set(t.name,t),t.componentAdded.add(this.componentAdded),t.componentRemoved.add(this.componentRemoved),t.nameChanged.add(this.entityNameChanged);try{for(var i=__values(this.families.values()),o=i.next();!o.done;o=i.next()){o.value.newEntity(t)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}},Engine.prototype.removeEntity=function(t){var e,n;t.componentAdded.remove(this.componentAdded),t.componentRemoved.remove(this.componentRemoved),t.nameChanged.remove(this.entityNameChanged);try{for(var i=__values(this.families.values()),o=i.next();!o.done;o=i.next()){o.value.removeEntity(t)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}this.entityNames.delete(t.name),this.entityList.remove(t)},Engine.prototype.getEntityByName=function(t){return this.entityNames.get(t)||null},Engine.prototype.removeAllEntities=function(){for(;this.entityList.head;)this.removeEntity(this.entityList.head)},Object.defineProperty(Engine.prototype,"entities",{get:function(){for(var t=[],e=this.entityList.head;e;e=e.next)t[t.length]=e;return t},enumerable:!0,configurable:!0}),Engine.prototype.getNodeList=function(t){if(this.families.has(t))return this.families.get(t).nodeList;var e=new this.familyClass(t,this);this.families.set(t,e);for(var n=this.entityList.head;n;n=n.next)e.newEntity(n);return e.nodeList},Engine.prototype.releaseNodeList=function(t){this.families.has(t)&&this.families.get(t).cleanUp(),this.families.delete(t)},Engine.prototype.addSystem=function(t,e){t.priority=e,t.addToEngine(this),this.systemList.add(t)},Engine.prototype.getSystem=function(t){return this.systemList.get(t)},Object.defineProperty(Engine.prototype,"systems",{get:function(){for(var t=[],e=this.systemList.head;e;e=e.next)t[t.length]=e;return t},enumerable:!0,configurable:!0}),Engine.prototype.removeSystem=function(t){this.systemList.remove(t),t.removeFromEngine(this)},Engine.prototype.removeAllSystems=function(){for(;this.systemList.head;){var t=this.systemList.head;this.systemList.head=this.systemList.head.next,t.previous=null,t.next=null,t.removeFromEngine(this)}this.systemList.tail=null},Engine.prototype.update=function(t){this.updating=!0;for(var e=this.systemList.head;e;e=e.next)e.update(t);this.updating=!1,this.updateComplete.dispatch()},Engine}(),v=function(){function Entity(t){void 0===t&&(t=""),this.previous=null,this.next=null,this.componentAdded=new a,this.componentRemoved=new a,this.nameChanged=new a,this.components=new Map,t?this.pName=t:(Entity.nameCount+=1,this.pName="_entity"+Entity.nameCount)}return Object.defineProperty(Entity.prototype,"name",{get:function(){return this.pName},set:function(t){if(this.pName!==t){var e=this.pName;this.pName=t,this.nameChanged.dispatch(this,e)}},enumerable:!0,configurable:!0}),Entity.prototype.add=function(t,e){if(void 0===e&&(e=null),e||(e=t.constructor.prototype.constructor),!e)throw new Error("Unable to get type of component: "+t);return this.components.has(e)&&this.remove(e),this.components.set(e,t),this.componentAdded.dispatch(this,e),this},Entity.prototype.remove=function(t){var e=this.components.get(t);return e?(this.components.delete(t),this.componentRemoved.dispatch(this,t),e):null},Entity.prototype.get=function(t){return this.components.get(t)||null},Entity.prototype.getAll=function(){var t,e,n=[];try{for(var i=__values(this.components.values()),o=i.next();!o.done;o=i.next()){var r=o.value;n.push(r)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}return n},Entity.prototype.has=function(t){return this.components.has(t)},Entity.nameCount=0,Entity}(),m=function(){return function Node(){this.previous=null,this.next=null}}(),g=function(){return function System(){this.previous=null,this.next=null,this.priority=0}}(),S=function(){function ComponentInstanceProvider(t){this.instance=t}return ComponentInstanceProvider.prototype.getComponent=function(){return this.instance},Object.defineProperty(ComponentInstanceProvider.prototype,"identifier",{get:function(){return this.instance},enumerable:!0,configurable:!0}),ComponentInstanceProvider}(),x=function(){function ComponentSingletonProvider(t){this.componentType=t}return ComponentSingletonProvider.prototype.getComponent=function(){return this.instance||(this.instance=new this.componentType),this.instance},Object.defineProperty(ComponentSingletonProvider.prototype,"identifier",{get:function(){return this.getComponent()},enumerable:!0,configurable:!0}),ComponentSingletonProvider}(),P=function(){function ComponentTypeProvider(t){this.componentType=t}return ComponentTypeProvider.prototype.getComponent=function(){return new this.componentType},Object.defineProperty(ComponentTypeProvider.prototype,"identifier",{get:function(){return this.componentType},enumerable:!0,configurable:!0}),ComponentTypeProvider}(),w=function(){function DynamicComponentProvider(t){this.closure=t}return DynamicComponentProvider.prototype.getComponent=function(){return this.closure()},Object.defineProperty(DynamicComponentProvider.prototype,"identifier",{get:function(){return this.closure},enumerable:!0,configurable:!0}),DynamicComponentProvider}(),C=function(){function StateComponentMapping(t,e){this.creatingState=t,this.componentType=e,this.withType(e)}return StateComponentMapping.prototype.withInstance=function(t){return this.setProvider(new S(t)),this},StateComponentMapping.prototype.withType=function(t){return this.setProvider(new P(t)),this},StateComponentMapping.prototype.withSingleton=function(t){return t||(t=this.componentType),this.setProvider(new x(t)),this},StateComponentMapping.prototype.withMethod=function(t){return this.setProvider(new w(t)),this},StateComponentMapping.prototype.withProvider=function(t){return this.setProvider(t),this},StateComponentMapping.prototype.add=function(t){return this.creatingState.add(t)},StateComponentMapping.prototype.setProvider=function(t){this.provider=t,this.creatingState.providers.set(this.componentType,t)},StateComponentMapping}(),E=function(){function EntityState(){this.providers=new Map}return EntityState.prototype.add=function(t){return new C(this,t)},EntityState.prototype.get=function(t){return this.providers.get(t)||null},EntityState.prototype.has=function(t){return this.providers.has(t)},EntityState}(),b=function(){function EntityStateMachine(t){this.entity=t,this.states=new Map}return EntityStateMachine.prototype.addState=function(t,e){return this.states.set(t,e),this},EntityStateMachine.prototype.createState=function(t){var e=new E;return this.states.set(t,e),e},EntityStateMachine.prototype.changeState=function(t){var e,n,i,o,r,s,a=this.states.get(t);if(!a)throw new Error("Entity state "+t+" doesn't exist");if(a!==this.currentState){var h;if(this.currentState){h=new Map;try{for(var l=__values(a.providers.keys()),p=l.next();!p.done;p=l.next()){var d=p.value;h.set(d,a.providers.get(d))}}catch(t){e={error:t}}finally{try{p&&!p.done&&(n=l.return)&&n.call(l)}finally{if(e)throw e.error}}try{for(var u=__values(this.currentState.providers.keys()),c=u.next();!c.done;c=u.next()){d=c.value;var y=h.get(d)||null;y&&y.identifier===this.currentState.providers.get(d).identifier?h.delete(d):this.entity.remove(d)}}catch(t){i={error:t}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(i)throw i.error}}}else h=a.providers;try{for(var f=__values(h.keys()),v=f.next();!v.done;v=f.next()){d=v.value;this.entity.add(h.get(d).getComponent(),d)}}catch(t){r={error:t}}finally{try{v&&!v.done&&(s=f.return)&&s.call(f)}finally{if(r)throw r.error}}this.currentState=a}},EntityStateMachine.prototype.getStateNames=function(){return Object.keys(this.states)},EntityStateMachine}(),L=function(){function DynamicSystemProvider(t){this.systemPriority=0,this.method=t}return DynamicSystemProvider.prototype.getSystem=function(){return this.method()},Object.defineProperty(DynamicSystemProvider.prototype,"identifier",{get:function(){return this.method},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicSystemProvider.prototype,"priority",{get:function(){return this.systemPriority},set:function(t){this.systemPriority=t},enumerable:!0,configurable:!0}),DynamicSystemProvider}(),_=function(){function StateSystemMapping(t,e){this.creatingState=t,this.provider=e}return StateSystemMapping.prototype.withPriority=function(t){return this.provider.priority=t,this},StateSystemMapping.prototype.addInstance=function(t){return this.creatingState.addInstance(t)},StateSystemMapping.prototype.addSingleton=function(t){return this.creatingState.addSingleton(t)},StateSystemMapping.prototype.addMethod=function(t){return this.creatingState.addMethod(t)},StateSystemMapping.prototype.addProvider=function(t){return this.creatingState.addProvider(t)},StateSystemMapping}(),N=function(){function SystemInstanceProvider(t){this.systemPriority=0,this.instance=t}return SystemInstanceProvider.prototype.getSystem=function(){return this.instance},Object.defineProperty(SystemInstanceProvider.prototype,"identifier",{get:function(){return this.instance},enumerable:!0,configurable:!0}),Object.defineProperty(SystemInstanceProvider.prototype,"priority",{get:function(){return this.systemPriority},set:function(t){this.systemPriority=t},enumerable:!0,configurable:!0}),SystemInstanceProvider}(),T=function(){function SystemSingletonProvider(t){this.systemPriority=0,this.componentType=t}return SystemSingletonProvider.prototype.getSystem=function(){return this.instance||(this.instance=new this.componentType),this.instance},Object.defineProperty(SystemSingletonProvider.prototype,"identifier",{get:function(){return this.getSystem()},enumerable:!0,configurable:!0}),Object.defineProperty(SystemSingletonProvider.prototype,"priority",{get:function(){return this.systemPriority},set:function(t){this.systemPriority=t},enumerable:!0,configurable:!0}),SystemSingletonProvider}(),M=function(){function EngineState(){this.providers=[]}return EngineState.prototype.addInstance=function(t){return this.addProvider(new N(t))},EngineState.prototype.addSingleton=function(t){return this.addProvider(new T(t))},EngineState.prototype.addMethod=function(t){return this.addProvider(new L(t))},EngineState.prototype.addProvider=function(t){var e=new _(this,t);return this.providers[this.providers.length]=t,e},EngineState}(),A=function(){function EngineStateMachine(t){this.engine=t,this.states=new Map}return EngineStateMachine.prototype.addState=function(t,e){return this.states.set(t,e),this},EngineStateMachine.prototype.createState=function(t){var e=new M;return this.states.set(t,e),e},EngineStateMachine.prototype.changeState=function(t){var e,n,i,o,r,s,a=this.states.get(t);if(!a)throw new Error("Engine state "+t+" doesn't exist");if(a!==this.currentState){var h,l=[];try{for(var p=__values(a.providers),d=p.next();!d.done;d=p.next()){l[h=(v=d.value).identifier]=v}}catch(t){e={error:t}}finally{try{d&&!d.done&&(n=p.return)&&n.call(p)}finally{if(e)throw e.error}}if(this.currentState)try{for(var u=__values(this.currentState.providers),c=u.next();!c.done;c=u.next()){l[h=(v=c.value).identifier]?delete l[h]:this.engine.removeSystem(v.getSystem())}}catch(t){i={error:t}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(i)throw i.error}}try{for(var y=__values(l),f=y.next();!f.done;f=y.next()){var v=f.value;this.engine.addSystem(v.getSystem(),v.priority)}}catch(t){r={error:t}}finally{try{f&&!f.done&&(s=y.return)&&s.call(y)}finally{if(r)throw r.error}}this.currentState=a}},EngineStateMachine.prototype.getStateNames=function(){return Object.keys(this.states)},EngineStateMachine}(),I=function(t){function RAFTickProvider(){var e=null!==t&&t.apply(this,arguments)||this;return e.rafId=0,e.previousTime=0,e.update=function(){e.rafId=window.requestAnimationFrame(e.update);var t=Date.now();e.dispatch((t-e.previousTime)/1e3),e.previousTime=t},e}return __extends(RAFTickProvider,t),RAFTickProvider.prototype.start=function(){this.previousTime=Date.now(),this.rafId=window.requestAnimationFrame(this.update)},RAFTickProvider.prototype.stop=function(){window.cancelAnimationFrame(this.rafId),this.rafId=0},Object.defineProperty(RAFTickProvider.prototype,"playing",{get:function(){return!!this.rafId},enumerable:!0,configurable:!0}),RAFTickProvider}(s),O=function(t){function IntervalTickProvider(e){var n=t.call(this)||this;return n.intervalId=0,n.previousTime=0,n.pInterval=33,n.update=function(){var t=Date.now();n.dispatch((t-n.previousTime)/1e3),n.previousTime=t},e&&(n.pInterval=e),n}return __extends(IntervalTickProvider,t),IntervalTickProvider.prototype.start=function(){this.previousTime=Date.now(),this.intervalId=window.setInterval(this.update,this.pInterval)},IntervalTickProvider.prototype.stop=function(){window.clearInterval(this.intervalId),this.intervalId=0},Object.defineProperty(IntervalTickProvider.prototype,"interval",{set:function(t){this.pInterval=t,0!==this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=window.setInterval(this.update,t))},enumerable:!0,configurable:!0}),Object.defineProperty(IntervalTickProvider.prototype,"inteval",{get:function(){return this.pInterval},enumerable:!0,configurable:!0}),Object.defineProperty(IntervalTickProvider.prototype,"playing",{get:function(){return!!this.intervalId},enumerable:!0,configurable:!0}),IntervalTickProvider}(s),j=function(){function ComponentPool(){}return ComponentPool.getPool=function(t){if(ComponentPool.pools.has(t))return ComponentPool.pools.get(t);var e=[];return ComponentPool.pools.set(t,e),e},ComponentPool.get=function(t){var e=ComponentPool.getPool(t);return e.length>0?e.pop():new t},ComponentPool.dispose=function(t){if(t){var e=t.constructor.prototype.constructor,n=ComponentPool.getPool(e);n[n.length]=t}},ComponentPool.empty=function(){ComponentPool.pools=new Map},ComponentPool.pools=new Map,ComponentPool}(),k=function(t){function ListIteratingSystem(e){var n=t.call(this)||this;return n.nodeList=null,n.nodeClass=e,n}return __extends(ListIteratingSystem,t),ListIteratingSystem.prototype.addToEngine=function(t){if(this.nodeList=t.getNodeList(this.nodeClass),this.nodeAdded){for(var e=this.nodeList.head;e;e=e.next)this.nodeAdded(e);this.nodeList.nodeAdded.add(this.nodeAdded)}this.nodeRemoved&&this.nodeList.nodeRemoved.add(this.nodeRemoved)},ListIteratingSystem.prototype.removeFromEngine=function(t){this.nodeAdded&&this.nodeList.nodeAdded.remove(this.nodeAdded),this.nodeRemoved&&this.nodeList.nodeRemoved.remove(this.nodeRemoved),this.nodeList=null},ListIteratingSystem.prototype.update=function(t){for(var e=this.nodeList.head;e;e=e.next)this.updateNode(e,t)},ListIteratingSystem}(g);t.Signal0=r,t.Signal1=s,t.Signal2=a,t.Signal3=h,t.ComponentMatchingFamily=u,t.keep=function keep(t){return function(e,n){var i,o=e.constructor;o.hasOwnProperty(d)?i=o[d]:(i=new Map,Object.defineProperty(o,d,{enumerable:!0,get:function(){return i}})),i.set(n,t)}},t.Engine=f,t.Entity=v,t.Node=m,t.NodePool=p,t.NodeList=l,t.System=g,t.EntityStateMachine=b,t.EngineStateMachine=A,t.RAFTickProvider=I,t.IntervalTickProvider=O,t.ComponentPool=j,t.ListIteratingSystem=k,Object.defineProperty(t,"__esModule",{value:!0})});
